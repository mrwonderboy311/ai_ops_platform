# AIOps 平台设计文档

**日期**: 2025-02-02
**版本**: v1.0
**状态**: 设计阶段

## 1. 概述

### 1.1 平台定位

面向中型企业（50-500 用户，管理 1000-10000 台主机）的 AIOps 平台，提供主机管理、K8s 管理、可观测性和 AI 智能分析四大核心能力。

### 1.2 核心模块

1. **主机管理** - 全生命周期管理（发现、注册、资产台账、变更记录）
2. **K8s 管理** - 完整平台（多集群、RBAC、Helm 应用管理）
3. **可观测性** - OpenTelemetry + Prometheus + Loki + Tempo
4. **AI 智能分析** - 异常检测、根因分析、自然语言查询、LLM 辅助诊断

### 1.3 技术栈

- **后端**: Go + gRPC
- **前端**: React 18 + TypeScript
- **部署**: 微服务架构 + 容器化

---

## 2. 整体架构

### 2.1 微服务架构

```
┌─────────────────────────────────────────────────────────────┐
│                         API Gateway                          │
│              (认证、限流、路由、协议转换)                       │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   host-svc   │    │   k8s-svc    │    │   obs-svc    │
│  主机管理服务  │    │  K8s管理服务  │    │ 可观测性服务  │
└──────────────┘    └──────────────┘    └──────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
                    ┌──────────────┐
                    │   ai-svc     │
                    │  AI分析服务   │
                    └──────────────┘
```

### 2.2 服务定义

#### 2.2.1 主机管理服务 (host-svc)

| 功能模块 | 说明 |
|---------|------|
| 主机发现 | SSH 被动扫描 + Agent 主动上报 |
| 自动注册 | 首次发现自动注册，支持审批流程 |
| 资产台账 | 硬件信息、操作系统、网络配置、标签分组 |
| 运维操作 | SSH 终端、文件传输、进程管理、服务控制 |
| 批量任务 | 并发控制、任务编排、执行历史 |

#### 2.2.2 Kubernetes 管理服务 (k8s-svc)

| 功能模块 | 说明 |
|---------|------|
| 多集群接入 | Kubeconfig 管理、Service Account |
| CRD 管理 | Workload、Service、Ingress、ConfigMap、Secret |
| Pod 交互 | 日志流、终端执行（WebSocket 代理） |
| Helm 管理 | Chart 仓库、应用安装/升级/回滚 |

#### 2.2.3 可观测性服务 (obs-svc)

| 功能模块 | 说明 |
|---------|------|
| 数据采集 | OpenTelemetry Collector 接入 |
| 统一查询 | 指标/日志/链路关联查询 API |
| 数据路由 | 对接 Prometheus/Loki/Tempo |

#### 2.2.4 AI 分析服务 (ai-svc)

| 功能模块 | 说明 |
|---------|------|
| 异常检测 | 时序预测、日志异常模式识别 |
| 智能告警 | 告警聚合、降噪、根因关联 |
| LLM 集成 | 自然语言查询、智能诊断助手 |

### 2.3 通信协议

- **外部**: REST API (JSON)
- **内部**: gRPC (Protobuf)
- **实时**: WebSocket (日志流、终端、告警推送)

---

## 3. 数据架构

### 3.1 存储选型

| 存储类型 | 技术选型 | 用途 |
|---------|---------|------|
| 关系型数据库 | PostgreSQL | 业务数据、配置、权限 |
| 时序数据库 | Prometheus | 指标存储 |
| 日志存储 | Loki | 原生日志 |
| 链路存储 | Tempo | 分布式追踪 |
| 缓存 | Redis | 会话、状态缓存 |
| 消息队列 | Kafka | 异步任务、事件流 |

### 3.2 数据保留策略

| 数据类型 | 热数据 | 冷数据 |
|---------|--------|--------|
| 指标 | 7 天 | 90 天 |
| 日志 | 7 天 | 30 天 |
| 链路 | 3 天 | 7 天 |
| 审计日志 | 永久 | - |

### 3.3 数据流

```
┌─────────────┐    ┌──────────────────┐    ┌─────────┐
│   Agent     │───▶│ OTel Collector   │───▶│  Kafka  │
│ (主机/Pod)  │    │                  │    │         │
└─────────────┘    └──────────────────┘    └────┬────┘
                                               │
         ┌─────────────────────────────────────┼─────────────────────────────────────┐
         │                                     │                                     │
         ▼                                     ▼                                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   host-svc   │    │   k8s-svc    │    │   obs-svc    │    │   ai-svc     │
│              │    │              │    │              │    │              │
└──────┬───────┘    └──────┬───────┘    └──────┬───────┘    └──────┬───────┘
       │                   │                   │                   │
       └───────────────────┼───────────────────┼───────────────────┘
                           ▼                   ▼
                    ┌──────────┐        ┌──────────┐
                    │PostgreSQL│        │  Redis   │
                    └──────────┘        └──────────┘
```

---

## 4. AI 智能分析设计

### 4.1 异常检测

| 类型 | 算法 | 说明 |
|-----|------|-----|
| 指标异常 | STL + 统计分析 | 趋势突变、周期异常检测 |
| 日志异常 | 孤立森林 / LSTM | 日志模板异常识别 |
| 基线学习 | 时间序列分解 | 按小时/星期/季节学习基线 |

### 4.2 智能告警

- **告警聚合**: 基于时间窗口和相关性的聚合
- **根因关联**: 拓扑图追溯（主机 → Pod → Service → 应用）
- **降噪规则**: 已知良性告警抑制、重复去重

### 4.3 预测分析

- **容量预测**: 资源耗尽时间预测
- **故障预测**: 异常模式提前预警

### 4.4 LLM 集成

| 功能 | 说明 |
|-----|------|
| 自然语言查询 | "CPU 超过 80% 的 Pod" → PromQL/LogQL |
| 智能诊断 | 结合知识库 + 实时数据输出诊断建议 |
| 告警解释 | 复杂告警转换为自然语言 |

### 4.5 技术实现

- **轻量级 ML**: scikit-learn/XGBoost 本地部署
- **LLM**: API 调用（支持多云厂商切换）
- **向量数据库**: Milvus 存储 RAG 知识库

---

## 5. 前端架构

### 5.1 技术栈

| 类别 | 技术 |
|-----|------|
| 框架 | React 18 + TypeScript |
| UI 组件 | Ant Design / Arco Design |
| 状态管理 | Zustand / Jotai |
| 数据请求 | React Query + Axios |
| 路由 | React Router v6 |
| 图表 | ECharts / AntV |
| 日志查看器 | 自定义虚拟滚动 |
| 终端 | xterm.js |
| 编辑器 | Monaco Editor |

### 5.2 页面结构

```
├── 主机管理
│   ├── 主机列表
│   ├── 主机详情
│   │   ├── 基本信息
│   │   ├── 监控图表
│   │   ├── 进程列表
│   │   └── 文件管理
│   ├── Web SSH
│   └── 批量任务
├── K8s 管理
│   ├── 集群列表
│   ├── Workload
│   │   ├── Deployment
│   │   ├── StatefulSet
│   │   └── DaemonSet
│   ├── Pod
│   │   ├── 列表
│   │   ├── 详情
│   │   ├── 日志
│   │   └── 终端
│   ├── Service/Ingress
│   ├── ConfigMap/Secret
│   └── Helm 应用
├── 可观测性
│   ├── 仪表盘
│   ├── 指标查询
│   ├── 日志查询
│   └── 链路追踪
└── AI 智能助手
    ├── 自然语言查询
    ├── 告警分析
    └── 智能诊断
```

### 5.3 实时通信

| 场景 | 技术 |
|-----|------|
| 主机状态 | WebSocket |
| Pod 日志流 | WebSocket |
| 终端 | WebSocket |
| 实时告警 | WebSocket / SSE |
| 仪表盘更新 | SSE |

---

## 6. 安全与权限

### 6.1 认证方式

| 方式 | 说明 |
|-----|------|
| 本地账号 | 用户名/密码（bcrypt 加密） |
| LDAP/AD | 企业级 SSO |
| OAuth 2.0 / SAML | 第三方身份提供商 |
| API Token | API 调用、Agent 认证 |

### 6.2 RBAC 权限模型

```
用户 → 角色 → 权限 → 资源
```

**预定义角色**:
- 超级管理员
- 运维人员
- 只读用户
- 审计员

**资源级权限**:
- 可限定到特定集群、命名空间、主机组

### 6.3 审计日志

- 所有操作记录（谁、何时、做了什么、结果）
- 敏感操作二次确认
- 审计日志不可修改

### 6.4 安全加固

| 层面 | 措施 |
|-----|------|
| 通信 | 全站 HTTPS (TLS 1.3)、内部 mTLS |
| Agent | 双向认证、Token 轮换 |
| 敏感数据 | 字段加密、Secret 加密、日志脱敏 |
| API | Rate Limiting、防注入、CSRF/XSS 防护 |

---

## 7. 部署架构

### 7.1 容器化部署

```
┌─────────────────────────────────────────────────────────┐
│                      Kubernetes Cluster                  │
│  ┌───────────────────────────────────────────────────┐  │
│  │                  Ingress / Nginx                   │  │
│  └───────────────────────────────────────────────────┘  │
│                          │                              │
│  ┌───────────────────────────────────────────────────┐  │
│  │                   API Gateway                      │  │
│  └───────────────────────────────────────────────────┘  │
│                          │                              │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐ │
│  │host-svc  │ k8s-svc  │ obs-svc  │ ai-svc   │frontend  │ │
│  │  (3+)    │  (3+)    │  (2+)    │  (2+)    │  (2+)    │ │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘ │
│                                                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │              依赖服务 (StatefulSet)                │  │
│  │  PostgreSQL │ Redis │ Kafka │ Prometheus │ Loki   │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 7.2 高可用设计

| 组件 | 方案 |
|-----|------|
| API Gateway | 多副本 + 负载均衡 |
| 无状态服务 | 水平扩展 + HPA |
| PostgreSQL | 主从复制 |
| Redis | 哨兵/集群 |
| Kafka | 3 节点集群 |

### 7.3 Agent 部署

| 场景 | 方式 |
|-----|------|
| K8s 集群 | DaemonSet |
| 裸金属/虚拟机 | Systemd 服务 |

---

## 8. 开发路线图

### Phase 1: 基础框架 (2-3 周)

- [ ] Go monorepo 项目结构
- [ ] API Gateway + 中间件（认证、日志、限流）
- [ ] PostgreSQL 设计 + ORM
- [ ] React 前端脚手架
- [ ] 基础 UI 布局

### Phase 2: 主机管理 (3-4 周)

- [ ] Agent 开发（信息采集、SSH 代理）
- [ ] 主机注册/发现 API
- [ ] 前端主机列表/详情
- [ ] Web SSH (xterm.js + WebSocket)
- [ ] 批量任务引擎

### Phase 3: K8s 管理 (4-5 周)

- [ ] 集群接入（Kubeconfig）
- [ ] CRD 资源 CRUD
- [ ] Pod 日志/终端 WebSocket
- [ ] Helm 集成
- [ ] 前端管理界面

### Phase 4: 可观测性 (3-4 周)

- [ ] OTel Collector 部署
- [ ] Prometheus/Loki/Tempo 对接
- [ ] 统一查询 API
- [ ] 前端仪表盘
- [ ] 日志/指标查询界面

### Phase 5: AI 智能分析 (4-5 周)

- [ ] 异常检测模型
- [ ] 告警聚合与根因分析
- [ ] LLM 集成
- [ ] 自然语言查询
- [ ] 智能诊断助手

### Phase 6: 安全与权限 (2 周)

- [ ] RBAC 系统
- [ ] 审计日志
- [ ] 安全加固

### Phase 7: 测试与优化 (2-3 周)

- [ ] 集成测试
- [ ] 性能测试
- [ ] 文档编写
- [ ] 部署优化

---

## 9. 目录结构

```
myops-k8s-platform/
├── backend/
│   ├── api-gateway/          # API 网关
│   │   ├── cmd/
│   │   ├── internal/
│   │   │   ├── middleware/   # 认证、限流、日志
│   │   │   ├── proxy/        # 服务代理
│   │   │   └── config/
│   │   └── go.mod
│   ├── host-svc/             # 主机管理服务
│   │   ├── cmd/
│   │   ├── internal/
│   │   │   ├── agent/        # Agent API
│   │   │   ├── host/         # 主机管理
│   │   │   ├── task/         # 任务引擎
│   │   │   └── ssh/          # SSH 代理
│   │   └── go.mod
│   ├── k8s-svc/              # K8s 管理服务
│   │   ├── cmd/
│   │   ├── internal/
│   │   │   ├── cluster/      # 集群管理
│   │   │   ├── resource/     # CRD 资源
│   │   │   ├── pod/          # Pod 操作
│   │   │   └── helm/         # Helm 集成
│   │   └── go.mod
│   ├── obs-svc/              # 可观测性服务
│   │   ├── cmd/
│   │   ├── internal/
│   │   │   ├── collector/    # OTel 接入
│   │   │   ├── query/        # 统一查询
│   │   │   └── metric/       # 指标处理
│   │   └── go.mod
│   ├── ai-svc/               # AI 分析服务
│   │   ├── cmd/
│   │   ├── internal/
│   │   │   ├── anomaly/      # 异常检测
│   │   │   ├── alert/        # 告警聚合
│   │   │   ├── llm/          # LLM 集成
│   │   │   └── rag/          # RAG 检索
│   │   └── go.mod
│   ├── pkg/                  # 共享代码
│   │   ├── auth/             # 认证工具
│   │   ├── db/               # 数据库
│   │   ├── kafka/            # 消息队列
│   │   ├── redis/            # 缓存
│   │   └── proto/            # Protobuf 定义
│   └── scripts/              # 部署脚本
├── frontend/                 # React 前端
│   ├── src/
│   │   ├── pages/            # 页面组件
│   │   ├── components/       # 通用组件
│   │   ├── hooks/            # 自定义 Hooks
│   │   ├── api/              # API 调用
│   │   ├── store/            # 状态管理
│   │   └── types/            # TypeScript 类型
│   ├── package.json
│   └── vite.config.ts
├── agent/                    # 主机 Agent
│   ├── cmd/
│   ├── internal/
│   │   ├── collector/        # 信息采集
│   │   ├── sshd/             # SSH 服务
│   │   └── upstream/         # 上报通信
│   └── go.mod
├── deploy/                   # K8s 部署
│   ├── helm/                 # Helm Charts
│   ├── k8s/                  # 原生 K8s YAML
│   └── docker-compose.yml    # 本地开发
├── docs/                     # 文档
│   ├── plans/                # 设计文档
│   ├── api/                  # API 文档
│   └── user-guide/           # 用户手册
└── README.md
```

---

## 10. 非功能性需求

### 10.1 性能指标

| 指标 | 目标 |
|-----|------|
| API 响应时间 | P95 < 200ms |
| 日志查询延迟 | < 2s |
| 并发用户 | 支持 500+ |
| 数据采集延迟 | < 10s |

### 10.2 可扩展性

- 服务水平扩展
- 数据库读写分离
- Kafka 分区扩展

### 10.3 可靠性

- 服务可用性 > 99.5%
- 数据持久化保证
- 自动故障恢复

---

## 11. 附录

### 11.1 参考资料

- [OpenTelemetry 官方文档](https://opentelemetry.io/)
- [Prometheus 文档](https://prometheus.io/docs/)
- [Kubernetes API 文档](https://kubernetes.io/docs/reference/kubernetes-api/)

### 11.2 变更记录

| 日期 | 版本 | 说明 |
|-----|------|-----|
| 2025-02-02 | v1.0 | 初始设计 |
